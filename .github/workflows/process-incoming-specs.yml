name: Process Incoming OpenAPI Specs

on:
  push:
    branches: [ main ]
    paths:
      - 'incoming/**'

jobs:
  process-specs:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout apidocs repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: |
        npm install -g @redocly/cli
        npm install js-yaml

    - name: Process all incoming specs
      run: |
        echo "ğŸ” Searching for new incoming specs..."

        # incoming ë””ë ‰í† ë¦¬ì—ì„œ ìƒˆë¡œìš´ ìŠ¤í™ íŒŒì¼ ì°¾ê¸°
        find incoming -name ".trigger" 2>/dev/null | while read trigger_file; do

          SPEC_DIR=$(dirname "$trigger_file")
          SERVICE_METADATA="$SPEC_DIR/service-metadata.json"

          if [[ -f "$SERVICE_METADATA" ]]; then
            # ë©”íƒ€ë°ì´í„°ì—ì„œ ì •ë³´ ì¶”ì¶œ
            SERVICE_NAME=$(cat "$SERVICE_METADATA" | jq -r '.service_name')
            VERSION=$(cat "$SERVICE_METADATA" | jq -r '.version')
            DEPLOY_TYPE=$(cat "$SERVICE_METADATA" | jq -r '.deploy_type')
            GENERATED_AT=$(cat "$SERVICE_METADATA" | jq -r '.generated_at')

            echo "ğŸ”„ Processing $SERVICE_NAME $VERSION ($DEPLOY_TYPE)"

            # ëŒ€ìƒ ë””ë ‰í† ë¦¬ ê²°ì •
            if [[ "$DEPLOY_TYPE" == "release" ]]; then
              TARGET_DIR="services/$SERVICE_NAME/versions/$VERSION"
            else
              TARGET_DIR="services/$SERVICE_NAME/dev-branches/$VERSION"
            fi

            # ì´ì „ ë²„ì „ê³¼ ë³€ê²½ì‚¬í•­ ë¹„êµ (ì¤‘ì•™ì§‘ì¤‘ì‹!)
            echo "ğŸ” Detecting changes for $SERVICE_NAME $VERSION"
            bash scripts/detect-and-analyze-changes.sh "$SERVICE_NAME" "$SPEC_DIR" "$TARGET_DIR" || echo "Change detection failed, continuing..."

            # ìŠ¤í™ íŒŒì¼ ì´ë™
            echo "ğŸ“ Moving files to $TARGET_DIR"
            mkdir -p "$TARGET_DIR"
            cp "$SPEC_DIR"/*.yaml "$TARGET_DIR/" 2>/dev/null || echo "No YAML files to copy"
            cp "$SPEC_DIR"/*.json "$TARGET_DIR/" 2>/dev/null || echo "No JSON files to copy"
            cp "$SERVICE_METADATA" "$TARGET_DIR/"

            # HTML ë¬¸ì„œ ìƒì„±
            echo "ğŸ¨ Generating HTML documentation"
            bash scripts/generate-html-docs.sh "$TARGET_DIR" || echo "HTML generation failed, continuing..."

            # latest ë§í¬ ì—…ë°ì´íŠ¸ (ë¦´ë¦¬ìŠ¤ì¸ ê²½ìš°)
            if [[ "$DEPLOY_TYPE" == "release" ]]; then
              echo "ğŸ”— Updating latest link for $SERVICE_NAME"
              rm -rf "services/$SERVICE_NAME/latest"
              mkdir -p "services/$SERVICE_NAME"
              ln -sf "versions/$VERSION" "services/$SERVICE_NAME/latest"
            fi

            # ì²˜ë¦¬ ì™„ë£Œëœ incoming íŒŒì¼ ì œê±°
            echo "ğŸ§¹ Cleaning up incoming files"
            rm -rf "$SPEC_DIR"

            echo "âœ… Completed processing $SERVICE_NAME $VERSION"
          else
            echo "âš ï¸  No service metadata found in $SPEC_DIR"
          fi
        done

    - name: Update version timeline
      run: |
        echo "ğŸ“Š Updating version timeline"
        # ì „ì²´ ì„œë¹„ìŠ¤ì˜ ë²„ì „ íƒ€ì„ë¼ì¸ ì—…ë°ì´íŠ¸ (ì¶”í›„ êµ¬í˜„)
        # node scripts/update-version-timeline.js
        echo "Version timeline update will be implemented in Phase 2"

    - name: Commit processed documentation
      run: |
        git config user.name "GitHub Actions Bot (apidocs)"
        git config user.email "actions@github.com"

        if [[ -n $(git status --porcelain) ]]; then
          git add .
          git commit -m "ğŸ“š Process and deploy documentation updates

          - Generated HTML from incoming OpenAPI specs
          - Updated service documentation and latest links
          - Timestamp: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          git push

          echo "âœ… Documentation successfully processed and deployed"
        else
          echo "â„¹ï¸  No documentation changes to commit"
        fi

    - name: Output processing results
      run: |
        echo "ğŸ‰ Incoming specs processing completed!"
        echo ""
        echo "ğŸ“Š Current services:"
        find services -name "index.html" | head -10 | while read doc; do
          service_path=$(echo "$doc" | sed 's|/index.html||')
          echo "  ğŸ“š https://wishandcheers.github.io/apidocs/$service_path/"
        done