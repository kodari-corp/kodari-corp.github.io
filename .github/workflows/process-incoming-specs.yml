name: Process Incoming OpenAPI Specs

on:
  push:
    branches: [ main ]
    paths:
      - 'incoming/**'

jobs:
  process-specs:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout apidocs repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: |
        npm install -g @redocly/cli
        npm install js-yaml

    - name: Process all incoming specs
      run: |
        echo "ğŸ” Searching for new incoming specs..."

        # incoming ë””ë ‰í† ë¦¬ì—ì„œ ìƒˆë¡œìš´ ìŠ¤í™ íŒŒì¼ ì°¾ê¸°
        find incoming -name ".trigger" 2>/dev/null | while read trigger_file; do

          SPEC_DIR=$(dirname "$trigger_file")
          SERVICE_METADATA="$SPEC_DIR/service-metadata.json"

          if [[ -f "$SERVICE_METADATA" ]]; then
            # ë©”íƒ€ë°ì´í„°ì—ì„œ ì •ë³´ ì¶”ì¶œ
            SERVICE_NAME=$(cat "$SERVICE_METADATA" | jq -r '.service_name')
            VERSION=$(cat "$SERVICE_METADATA" | jq -r '.version')
            DEPLOY_TYPE=$(cat "$SERVICE_METADATA" | jq -r '.deploy_type')
            GENERATED_AT=$(cat "$SERVICE_METADATA" | jq -r '.generated_at')

            echo "ğŸ”„ Processing $SERVICE_NAME $VERSION ($DEPLOY_TYPE)"

            # ëŒ€ìƒ ë””ë ‰í† ë¦¬ ê²°ì •
            if [[ "$DEPLOY_TYPE" == "release" ]]; then
              TARGET_DIR="services/$SERVICE_NAME/versions/$VERSION"
            else
              TARGET_DIR="services/$SERVICE_NAME/dev-branches/$VERSION"
            fi

            # ì´ì „ ë²„ì „ê³¼ ë³€ê²½ì‚¬í•­ ë¹„êµ (Node.js ë²„ì „ - ê°œì„ ëœ ì—ëŸ¬ í•¸ë“¤ë§)
            echo "ğŸ” Detecting changes for $SERVICE_NAME $VERSION"
            node scripts/detect-and-analyze-changes.js "$SERVICE_NAME" "$SPEC_DIR" "$TARGET_DIR" || echo "Change detection failed, continuing..."

            # ìŠ¤í™ íŒŒì¼ ì´ë™
            echo "ğŸ“ Moving files to $TARGET_DIR"
            mkdir -p "$TARGET_DIR"
            cp "$SPEC_DIR"/*.yaml "$TARGET_DIR/" 2>/dev/null || echo "No YAML files to copy"
            cp "$SPEC_DIR"/*.json "$TARGET_DIR/" 2>/dev/null || echo "No JSON files to copy"
            cp "$SERVICE_METADATA" "$TARGET_DIR/"

            # HTML ë¬¸ì„œ ìƒì„± (Node.js ë²„ì „ - í´ë˜ìŠ¤ ê¸°ë°˜ Generator)
            echo "ğŸ¨ Generating HTML documentation"
            node scripts/generate-html-docs.js "$TARGET_DIR" || echo "HTML generation failed, continuing..."

            # latest ë§í¬ ì—…ë°ì´íŠ¸ (ë¦´ë¦¬ìŠ¤ì¸ ê²½ìš°)
            if [[ "$DEPLOY_TYPE" == "release" ]]; then
              echo "ğŸ”— Updating latest link for $SERVICE_NAME"
              rm -rf "services/$SERVICE_NAME/latest"
              mkdir -p "services/$SERVICE_NAME"
              ln -sf "versions/$VERSION" "services/$SERVICE_NAME/latest"
            fi

            # ì²˜ë¦¬ ì™„ë£Œëœ incoming íŒŒì¼ì„ archiveë¡œ ì´ë™ (ì¬ìƒì„± ë° íˆìŠ¤í† ë¦¬ ì¶”ì ìš©)
            echo "ğŸ“¦ Archiving incoming files for future regeneration"
            ARCHIVE_DIR="archive/$SERVICE_NAME/$DEPLOY_TYPE/$VERSION"
            mkdir -p "$ARCHIVE_DIR"

            # incoming íŒŒì¼ì„ archiveë¡œ ë³µì‚¬
            cp -r "$SPEC_DIR"/* "$ARCHIVE_DIR/" 2>/dev/null || echo "No files to archive"

            # archive íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë¡
            echo "$(date -u +'%Y-%m-%dT%H:%M:%SZ')" > "$ARCHIVE_DIR/.archived"

            # incoming íŒŒì¼ ì œê±°
            echo "ğŸ§¹ Cleaning up incoming files"
            rm -rf "$SPEC_DIR"

            echo "âœ… Completed processing $SERVICE_NAME $VERSION (archived to $ARCHIVE_DIR)"
          else
            echo "âš ï¸  No service metadata found in $SPEC_DIR"
          fi
        done

    - name: Update version timeline
      run: |
        echo "ğŸ“Š Updating version timeline data for all services"

        # íƒ€ì„ë¼ì¸ ë°ì´í„° ìƒì„±ì„ ìœ„í•œ ì¶”ê°€ dependencies ì„¤ì¹˜
        npm install jq

        # ëª¨ë“  ì„œë¹„ìŠ¤ì˜ íƒ€ì„ë¼ì¸ ë°ì´í„° ì—…ë°ì´íŠ¸
        node scripts/update-all-timelines.js ./services ./assets/data

        echo "âœ… Timeline data generation completed"

        # ì„œë¹„ìŠ¤ ì¸ë±ìŠ¤ í˜ì´ì§€ ìƒì„± (íƒ€ì„ë¼ì¸ í†µí•©)
        echo "ğŸ—ï¸  Generating service index pages with timeline integration"
        node scripts/generate-service-index.js ./services ./templates ./assets

        echo "âœ… Service index pages generation completed"

    - name: Update main index page
      run: |
        echo "ğŸ  Updating main index page with latest versions"
        node scripts/generate-main-index.js ./services ./templates ./index.html
        echo "âœ… Main index page updated with current service versions"

    - name: Generate changelog
      run: |
        echo "ğŸ“‹ Generating changelog from all version changes"
        node scripts/generate-changelog.js ./services ./changelog.html
        echo "âœ… Changelog generated with complete version history"

    - name: Commit processed documentation
      run: |
        git config user.name "GitHub Actions Bot (apidocs)"
        git config user.email "actions@github.com"

        if [[ -n $(git status --porcelain) ]]; then
          git add .
          git commit -m "ğŸ“š Process and deploy documentation updates

          - Generated HTML from incoming OpenAPI specs
          - Updated service documentation and latest links
          - Timestamp: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          git push

          echo "âœ… Documentation successfully processed and deployed"
        else
          echo "â„¹ï¸  No documentation changes to commit"
        fi

    - name: Output processing results
      run: |
        echo "ğŸ‰ Incoming specs processing completed!"
        echo ""
        echo "ğŸ“Š Current services:"
        find services -name "index.html" | head -10 | while read doc; do
          service_path=$(echo "$doc" | sed 's|/index.html||')
          echo "  ğŸ“š https://kodari-corp.github.io/$service_path/"
        done